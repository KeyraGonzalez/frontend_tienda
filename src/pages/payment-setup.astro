---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Estado de Configuración de Pagos - StyleShop">
  <Header />
  <main class="min-h-screen bg-gray-50 pt-24 pb-12">
    <div class="max-w-4xl mx-auto px-4">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Estado de Configuración de Pagos</h1>
        <p class="text-gray-600 mb-8">Estado actual de los métodos de pago configurados en el servidor.</p>

        <!-- Payment Status Cards -->
        <div id="payment-status" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <!-- Will be populated by JavaScript -->
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-blue-900 mb-3">Configuración del Servidor</h3>
          <div class="space-y-2 text-sm text-blue-800">
            <p><strong>Para configurar los métodos de pago:</strong></p>
            <ul class="list-disc list-inside ml-4 space-y-1">
              <li>Edita el archivo <code class="bg-blue-100 px-1 rounded">.env</code> en la carpeta <code class="bg-blue-100 px-1 rounded">backend/</code></li>
              <li>Añade tus claves reales de Stripe y PayPal</li>
              <li>Reinicia el servidor backend para aplicar los cambios</li>
            </ul>
            
            <div class="mt-4 p-4 bg-blue-100 rounded-lg">
              <p class="font-semibold">Variables de entorno necesarias:</p>
              <pre class="mt-2 text-xs bg-blue-200 p-2 rounded overflow-x-auto">
# Stripe
STRIPE_SECRET_KEY=sk_test_tu_clave_secreta
STRIPE_PUBLISHABLE_KEY=pk_test_tu_clave_publica
STRIPE_WEBHOOK_SECRET=whsec_tu_webhook_secret

# PayPal
PAYPAL_CLIENT_ID=tu_client_id
PAYPAL_CLIENT_SECRET=tu_client_secret
PAYPAL_ENVIRONMENT=sandbox  # o "production"</pre>
            </div>
            
            <p class="mt-4"><strong>Enlaces útiles:</strong></p>
            <ul class="list-disc list-inside ml-4 space-y-1">
              <li><a href="https://dashboard.stripe.com/apikeys" target="_blank" class="underline">Obtener claves de Stripe</a></li>
              <li><a href="https://developer.paypal.com/developer/applications/" target="_blank" class="underline">Crear aplicación PayPal</a></li>
              <li><a href="/PAYMENT_SETUP_GUIDE.md" target="_blank" class="underline">Guía completa de configuración</a></li>
            </ul>
          </div>
        </div>

        <!-- Refresh Button -->
        <div class="mt-6 text-center">
          <button 
            id="refresh-status-btn"
            class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
          >
            Actualizar Estado
          </button>
        </div>

        <!-- Status Message -->
        <div id="status-message" class="mt-6 p-4 rounded-lg hidden">
          <p id="status-text"></p>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script>
  async function loadPaymentStatus() {
    try {
      const response = await fetch('/api/payments/config');
      const config = await response.json();
      
      const statusContainer = document.getElementById('payment-status');
      if (!statusContainer) return;

      statusContainer.innerHTML = `
        <!-- Stripe Status -->
        <div class="border rounded-lg p-6 ${config.features.stripe_enabled ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
              <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none">
                <path d="M13.479 9.883c-1.626-.604-2.512-1.067-2.512-1.803 0-.622.511-.977 1.423-.977 1.667 0 3.379.642 4.558 1.22l.666-4.111c-.935-.446-2.847-1.177-5.49-1.177-1.87 0-3.425.489-4.558 1.401-1.204 1.023-1.807 2.357-1.807 3.935 0 2.357 1.807 3.893 4.558 4.464 1.647.604 2.512 1.132 2.512 1.846 0 .7-.598 1.177-1.558 1.177-2.512 0-4.558-1.111-5.315-1.534l-.666 4.111c1.069.489 3.14 1.245 6.315 1.245 1.693 0 3.425-.422 4.558-1.245 1.426-1.067 2.047-2.445 2.047-4.042 0-2.357-1.87-3.958-4.735-4.52z" fill="currentColor"/>
              </svg>
              Stripe
            </h3>
            <span class="px-3 py-1 rounded-full text-sm font-medium ${config.features.stripe_enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
              ${config.features.stripe_enabled ? 'Configurado' : 'No Configurado'}
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Clave Pública:</span>
              <span class="font-mono ${config.stripe.publishable_key ? 'text-green-600' : 'text-red-600'}">
                ${config.stripe.publishable_key ? config.stripe.publishable_key.substring(0, 20) + '...' : 'No configurada'}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Estado:</span>
              <span class="${config.features.stripe_enabled ? 'text-green-600' : 'text-red-600'}">
                ${config.features.stripe_enabled ? '✓ Listo para procesar pagos' : '✗ Requiere configuración'}
              </span>
            </div>
          </div>
        </div>

        <!-- PayPal Status -->
        <div class="border rounded-lg p-6 ${config.features.paypal_enabled ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
              <svg class="w-6 h-6 mr-2 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.988-.3c-.45-.05-.99-.075-1.6-.075h-4.194c-.524 0-.968.382-1.05.9L12.277 12.5c-.082.518.25.937.774.937h1.859c3.185 0 5.688-1.29 6.417-5.02.298-1.52.138-2.795-.605-3.5z"/>
              </svg>
              PayPal
            </h3>
            <span class="px-3 py-1 rounded-full text-sm font-medium ${config.features.paypal_enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
              ${config.features.paypal_enabled ? 'Configurado' : 'No Configurado'}
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Client ID:</span>
              <span class="font-mono ${config.paypal.client_id ? 'text-green-600' : 'text-red-600'}">
                ${config.paypal.client_id ? config.paypal.client_id.substring(0, 20) + '...' : 'No configurado'}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Entorno:</span>
              <span class="font-medium">
                ${config.paypal.environment}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Estado:</span>
              <span class="${config.features.paypal_enabled ? 'text-green-600' : 'text-red-600'}">
                ${config.features.paypal_enabled ? '✓ Listo para procesar pagos' : '✗ Requiere configuración'}
              </span>
            </div>
          </div>
        </div>
      `;

      // Show overall status
      const enabledMethods = [config.features.stripe_enabled, config.features.paypal_enabled].filter(Boolean).length;
      
      showStatus(
        enabledMethods > 0 
          ? `✓ ${enabledMethods} método${enabledMethods > 1 ? 's' : ''} de pago configurado${enabledMethods > 1 ? 's' : ''}`
          : '⚠️ No hay métodos de pago configurados. La tienda no puede procesar pedidos.',
        enabledMethods > 0 ? 'success' : 'warning'
      );

    } catch (error) {
      console.error('Error loading payment status:', error);
      showStatus('Error cargando estado de configuración', 'error');
    }
  }

  function showStatus(message: string, type: 'success' | 'error' | 'warning'): void {
    const statusEl = document.getElementById('status-message');
    const statusText = document.getElementById('status-text');
    if (!statusEl || !statusText) return;

    statusText.textContent = message;
    
    // Remove all status classes
    statusEl.classList.remove('bg-green-50', 'border-green-200', 'text-green-800');
    statusEl.classList.remove('bg-red-50', 'border-red-200', 'text-red-800');
    statusEl.classList.remove('bg-yellow-50', 'border-yellow-200', 'text-yellow-800');
    
    // Add appropriate classes based on type
    switch (type) {
      case 'success':
        statusEl.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
        break;
      case 'error':
        statusEl.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
        break;
      case 'warning':
        statusEl.classList.add('bg-yellow-50', 'border-yellow-200', 'text-yellow-800');
        break;
    }
    
    statusEl.classList.remove('hidden');
  }

  // Load status on page load
  document.addEventListener('DOMContentLoaded', loadPaymentStatus);

  // Refresh button
  document.getElementById('refresh-status-btn')?.addEventListener('click', loadPaymentStatus);
</script>
