---
// Header principal para el sitio
---

<header class="bg-black text-white">
  <!-- Promotions Section -->
  <div class="bg-black py-2">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-center text-center overflow-hidden">
        <div class="animate-scroll whitespace-nowrap">
          <div class="inline-flex items-center gap-6">
            <span class="text-xs font-medium tracking-wide uppercase text-white">üî• PROMOCIONES ESPECIALES</span>
            <span class="text-xs font-normal tracking-wide uppercase text-gray-300">ENV√çO GRATIS en compras mayores a $50</span>
            <span class="text-xs font-normal tracking-wide uppercase text-gray-300">20% OFF en tu primera compra</span>
            <span class="text-xs font-normal tracking-wide uppercase text-gray-300">DEVOLUCIONES GRATIS hasta 30 d√≠as</span>
            <!-- Duplicate for seamless loop -->
            <span class="text-xs font-medium tracking-wide uppercase text-white">üî• PROMOCIONES ESPECIALES</span>
            <span class="text-xs font-normal tracking-wide uppercase text-gray-300">ENV√çO GRATIS en compras mayores a $50</span>
            <span class="text-xs font-normal tracking-wide uppercase text-gray-300">20% OFF en tu primera compra</span>
            <span class="text-xs font-normal tracking-wide uppercase text-gray-300">DEVOLUCIONES GRATIS hasta 30 d√≠as</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Header -->
  <div class="bg-white py-6 shadow-sm border-b border-gray-200">
    <div class="max-w-full mx-auto px-6 sm:px-8 lg:px-12">
      <div class="flex items-center justify-between">
        <!-- Logo -->
        <div class="flex items-center">
          <a href="/" class="text-3xl font-bold text-black hover:text-gray-700 transition-colors tracking-wide uppercase">
            STYLEHUB
          </a>
        </div>

        <!-- Navigation Desktop -->
        <nav class="hidden md:flex items-center space-x-12">
          <!-- Mujer con submenu -->
          <div class="relative group">
            <a href="/productos?categoria=mujer" class="text-black hover:text-gray-600 transition-colors font-medium text-base tracking-wide uppercase flex items-center">
              MUJER
              <svg class="w-4 h-4 ml-1 group-hover:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </a>
            
            <!-- Submenu Mujer -->
            <div class="absolute top-full left-0 w-80 bg-white border-2 border-black shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50">
              <div class="p-6">
                <div class="grid grid-cols-2 gap-6">
                  <div>
                    <h4 class="font-bold text-black text-sm tracking-wide uppercase mb-3">Ropa</h4>
                    <ul class="space-y-2">
                      <li><a href="/productos?categoria=vestidos" class="text-gray-600 hover:text-black text-sm transition-colors">Vestidos</a></li>
                      <li><a href="/productos?categoria=blusas" class="text-gray-600 hover:text-black text-sm transition-colors">Blusas</a></li>
                      <li><a href="/productos?categoria=pantalones-mujer" class="text-gray-600 hover:text-black text-sm transition-colors">Pantalones</a></li>
                      <li><a href="/productos?categoria=faldas" class="text-gray-600 hover:text-black text-sm transition-colors">Faldas</a></li>
                      <li><a href="/productos?categoria=abrigos-mujer" class="text-gray-600 hover:text-black text-sm transition-colors">Abrigos</a></li>
                    </ul>
                  </div>
                  <div>
                    <h4 class="font-bold text-black text-sm tracking-wide uppercase mb-3">Accesorios</h4>
                    <ul class="space-y-2">
                      <li><a href="/productos?categoria=zapatos-mujer" class="text-gray-600 hover:text-black text-sm transition-colors">Zapatos</a></li>
                      <li><a href="/productos?categoria=bolsos" class="text-gray-600 hover:text-black text-sm transition-colors">Bolsos</a></li>
                      <li><a href="/productos?categoria=joyeria" class="text-gray-600 hover:text-black text-sm transition-colors">Joyer√≠a</a></li>
                      <li><a href="/productos?categoria=relojes-mujer" class="text-gray-600 hover:text-black text-sm transition-colors">Relojes</a></li>
                      <li><a href="/productos?categoria=gafas-mujer" class="text-gray-600 hover:text-black text-sm transition-colors">Gafas</a></li>
                    </ul>
                  </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                  <a href="/productos?categoria=mujer&featured=true" class="bg-black text-white px-4 py-2 rounded text-sm font-bold tracking-wide uppercase hover:bg-gray-800 transition-colors">
                    Ver Todo Mujer
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Hombre con submenu -->
          <div class="relative group">
            <a href="/productos?categoria=hombre" class="text-black hover:text-gray-600 transition-colors font-medium text-base tracking-wide uppercase flex items-center">
              HOMBRE
              <svg class="w-4 h-4 ml-1 group-hover:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </a>
            
            <!-- Submenu Hombre -->
            <div class="absolute top-full left-0 w-80 bg-white border-2 border-black shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50">
              <div class="p-6">
                <div class="grid grid-cols-2 gap-6">
                  <div>
                    <h4 class="font-bold text-black text-sm tracking-wide uppercase mb-3">Ropa</h4>
                    <ul class="space-y-2">
                      <li><a href="/productos?categoria=camisas" class="text-gray-600 hover:text-black text-sm transition-colors">Camisas</a></li>
                      <li><a href="/productos?categoria=camisetas" class="text-gray-600 hover:text-black text-sm transition-colors">Camisetas</a></li>
                      <li><a href="/productos?categoria=pantalones-hombre" class="text-gray-600 hover:text-black text-sm transition-colors">Pantalones</a></li>
                      <li><a href="/productos?categoria=jeans" class="text-gray-600 hover:text-black text-sm transition-colors">Jeans</a></li>
                      <li><a href="/productos?categoria=abrigos-hombre" class="text-gray-600 hover:text-black text-sm transition-colors">Abrigos</a></li>
                    </ul>
                  </div>
                  <div>
                    <h4 class="font-bold text-black text-sm tracking-wide uppercase mb-3">Accesorios</h4>
                    <ul class="space-y-2">
                      <li><a href="/productos?categoria=zapatos-hombre" class="text-gray-600 hover:text-black text-sm transition-colors">Zapatos</a></li>
                      <li><a href="/productos?categoria=carteras" class="text-gray-600 hover:text-black text-sm transition-colors">Carteras</a></li>
                      <li><a href="/productos?categoria=relojes-hombre" class="text-gray-600 hover:text-black text-sm transition-colors">Relojes</a></li>
                      <li><a href="/productos?categoria=cinturones" class="text-gray-600 hover:text-black text-sm transition-colors">Cinturones</a></li>
                      <li><a href="/productos?categoria=gafas-hombre" class="text-gray-600 hover:text-black text-sm transition-colors">Gafas</a></li>
                    </ul>
                  </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                  <a href="/productos?categoria=hombre&featured=true" class="bg-black text-white px-4 py-2 rounded text-sm font-bold tracking-wide uppercase hover:bg-gray-800 transition-colors">
                    Ver Todo Hombre
                  </a>
                </div>
              </div>
            </div>
          </div>

          <a href="/marcas" class="text-black hover:text-gray-600 transition-colors font-medium text-base tracking-wide uppercase">MARCAS</a>
          <a href="/productos?sale=true" class="text-black hover:text-gray-600 transition-colors font-medium text-base tracking-wide uppercase">SALE</a>
          <a href="/productos?nuevo=true" class="text-black hover:text-gray-600 transition-colors font-medium text-base tracking-wide uppercase">NUEVO</a>
        </nav>

        <!-- Auth Buttons / User Menu -->
        <div class="flex items-center space-x-4">
          <!-- Search Button -->
          <button id="search-toggle" class="text-black hover:text-gray-600 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>

          <!-- Guest Buttons (shown when not authenticated) -->
          <div id="guest-buttons" class="flex items-center space-x-4">
            <a href="/login" class="bg-black hover:bg-gray-800 px-6 py-3 text-white text-sm transition-colors font-medium tracking-wide uppercase border border-black">
              INICIAR SESI√ìN
            </a>
            <a href="/registro" class="bg-white hover:bg-gray-50 px-6 py-3 text-black text-sm transition-colors font-medium tracking-wide uppercase border border-black">
              REGISTRARSE
            </a>
          </div>

          <!-- Authenticated User Menu (hidden by default) -->
          <div id="user-menu" class="hidden flex items-center space-x-6">
            <!-- Cart Icon with Counter -->
            <div class="relative">
              <a href="/carrito" class="flex items-center text-black hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m2.6 8L6 5H3m4 8l1 6h12l1-6M8 13v6a1 1 0 001 1h12a1 1 0 001-1v-6"/>
                </svg>
                <span id="cart-counter" class="hidden absolute -top-2 -right-2 bg-black text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">0</span>
              </a>
            </div>

            <!-- User Profile Dropdown -->
            <div class="relative">
              <button id="user-dropdown-btn" class="flex items-center space-x-2 text-black hover:text-gray-600 transition-colors font-medium">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span id="user-name" class="hidden sm:inline text-sm tracking-wide uppercase"></span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              
              <!-- Dropdown Menu -->
              <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                <div class="py-2">
                  <a href="/perfil" class="block px-4 py-2 text-sm text-black hover:bg-gray-50 transition-colors font-medium tracking-wide uppercase">
                    MI PERFIL
                  </a>
                  <a href="/mis-pedidos" class="block px-4 py-2 text-sm text-black hover:bg-gray-50 transition-colors font-medium tracking-wide uppercase">
                    MIS PEDIDOS
                  </a>
                  <a id="admin-link" href="/admin" class="hidden px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors font-bold tracking-wide uppercase border border-black rounded">
                    <div class="flex items-center">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                      ADMINISTRACI√ìN
                    </div>
                  </a>
                  <div class="border-t border-gray-200 mt-2"></div>
                  <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-50 transition-colors font-medium tracking-wide uppercase">
                    CERRAR SESI√ìN
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Mobile Menu Button -->
          <button id="mobile-menu-button" class="md:hidden text-black hover:text-gray-600 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div id="mobile-menu" class="md:hidden mt-6 hidden">
        <div class="bg-gray-50 rounded-lg p-6 space-y-3 border border-gray-200">
          <!-- Mobile Mujer Menu -->
          <div class="mobile-menu-item">
            <button class="mobile-menu-toggle w-full text-left flex items-center justify-between text-black hover:text-gray-600 py-3 transition-colors font-medium text-base tracking-wide uppercase">
              MUJER
              <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="mobile-submenu hidden pl-4 space-y-2">
              <a href="/productos?categoria=vestidos" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Vestidos</a>
              <a href="/productos?categoria=blusas" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Blusas</a>
              <a href="/productos?categoria=pantalones-mujer" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Pantalones</a>
              <a href="/productos?categoria=zapatos-mujer" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Zapatos</a>
              <a href="/productos?categoria=bolsos" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Bolsos</a>
              <a href="/productos?categoria=mujer" class="block bg-black text-white px-3 py-2 rounded text-sm font-bold tracking-wide uppercase">Ver Todo</a>
            </div>
          </div>

          <!-- Mobile Hombre Menu -->
          <div class="mobile-menu-item">
            <button class="mobile-menu-toggle w-full text-left flex items-center justify-between text-black hover:text-gray-600 py-3 transition-colors font-medium text-base tracking-wide uppercase">
              HOMBRE
              <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="mobile-submenu hidden pl-4 space-y-2">
              <a href="/productos?categoria=camisas" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Camisas</a>
              <a href="/productos?categoria=camisetas" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Camisetas</a>
              <a href="/productos?categoria=pantalones-hombre" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Pantalones</a>
              <a href="/productos?categoria=zapatos-hombre" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Zapatos</a>
              <a href="/productos?categoria=relojes-hombre" class="block text-gray-600 hover:text-black py-2 text-sm transition-colors">Relojes</a>
              <a href="/productos?categoria=hombre" class="block bg-black text-white px-3 py-2 rounded text-sm font-bold tracking-wide uppercase">Ver Todo</a>
            </div>
          </div>

          <a href="/marcas" class="block text-black hover:text-gray-600 py-3 transition-colors font-medium text-base tracking-wide uppercase">MARCAS</a>
          <a href="/productos?sale=true" class="block text-black hover:text-gray-600 py-3 transition-colors font-medium text-base tracking-wide uppercase">SALE</a>
          <a href="/productos?nuevo=true" class="block text-black hover:text-gray-600 py-3 transition-colors font-medium text-base tracking-wide uppercase">NUEVO</a>
          <a href="/sport" class="block text-black hover:text-gray-600 py-3 transition-colors font-medium text-base tracking-wide uppercase">ZONA SPORT</a>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Search Modal -->
<div id="search-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex items-start justify-center min-h-screen pt-20 px-4 text-center">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
    
    <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full border-2 border-black">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-black tracking-wide uppercase">Buscar Productos</h3>
          <button id="close-search" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <div class="relative">
          <input 
            type="text" 
            id="search-input" 
            placeholder="¬øQu√© est√°s buscando?"
            class="w-full px-4 py-3 border-2 border-black rounded-lg focus:outline-none focus:ring-2 focus:ring-black text-lg"
            autocomplete="off"
          />
          <button id="search-submit" class="absolute right-3 top-3 text-gray-400 hover:text-black">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
        </div>
        
        <!-- Quick Search Suggestions -->
        <div class="mt-4">
          <p class="text-sm text-gray-600 mb-2 font-medium tracking-wide uppercase">B√∫squedas populares:</p>
          <div class="flex flex-wrap gap-2">
            <button onclick="quickSearch('vestidos')" class="bg-gray-100 text-black px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">Vestidos</button>
            <button onclick="quickSearch('zapatos')" class="bg-gray-100 text-black px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">Zapatos</button>
            <button onclick="quickSearch('camisas')" class="bg-gray-100 text-black px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">Camisas</button>
            <button onclick="quickSearch('jeans')" class="bg-gray-100 text-black px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">Jeans</button>
            <button onclick="quickSearch('bolsos')" class="bg-gray-100 text-black px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">Bolsos</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }
  
  .animate-scroll {
    animation: scroll 25s linear infinite;
  }
  
  .animate-scroll:hover {
    animation-play-state: paused;
  }
</style>

<script>
  import { authService } from '../utils/api/index';

  document.addEventListener('DOMContentLoaded', () => {
    // Mobile menu functionality
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
    }

    // Mobile submenu functionality
    const mobileMenuToggles = document.querySelectorAll('.mobile-menu-toggle');
    mobileMenuToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const submenu = toggle.nextElementSibling;
        const icon = toggle.querySelector('svg');
        
        if (submenu) {
          submenu.classList.toggle('hidden');
          if (icon) {
            icon.classList.toggle('rotate-180');
          }
        }
      });
    });

    // Search modal functionality
    const searchToggle = document.getElementById('search-toggle');
    const searchModal = document.getElementById('search-modal');
    const closeSearch = document.getElementById('close-search');
    const searchInput = document.getElementById('search-input');
    const searchSubmit = document.getElementById('search-submit');

    if (searchToggle && searchModal) {
      searchToggle.addEventListener('click', () => {
        searchModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
          if (searchInput) searchInput.focus();
        }, 100);
      });
    }

    if (closeSearch && searchModal) {
      closeSearch.addEventListener('click', () => {
        searchModal.classList.add('hidden');
        document.body.style.overflow = '';
      });
    }

    // Close search modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && searchModal && !searchModal.classList.contains('hidden')) {
        searchModal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    });

    // Close search modal on backdrop click
    if (searchModal) {
      searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
          searchModal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      });
    }

    // Handle search submission
    function performSearch() {
      const input = searchInput as HTMLInputElement;
      if (input && input.value.trim()) {
        const searchQuery = encodeURIComponent(input.value.trim());
        window.location.href = `/productos?search=${searchQuery}`;
      }
    }

    if (searchSubmit) {
      searchSubmit.addEventListener('click', performSearch);
    }

    if (searchInput) {
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          performSearch();
        }
      });
    }

    // Make quick search function global
    (window as any).quickSearch = function(term: string) {
      const searchQuery = encodeURIComponent(term);
      window.location.href = `/productos?search=${searchQuery}`;
    };

    // Initialize header state
    initializeHeader();
  });

  // Function to check if user is authenticated
  function isAuthenticated() {
    return authService.isAuthenticated();
  }

  // Function to get current user
  function getCurrentUser() {
    return authService.getCurrentUser();
  }

  // Function to initialize header state
  function initializeHeader() {
    updateHeaderAuth();
    updateCartCounter();
    
    // Set up user dropdown functionality
    setupUserDropdown();
    
    // Set up periodic cart updates if user is authenticated
    if (authService.isAuthenticated()) {
      setInterval(updateCartCounter, 30000); // Update every 30 seconds
    }
  }

  // Function to setup user dropdown
  function setupUserDropdown() {
    const userDropdownBtn = document.getElementById('user-dropdown-btn');
    const userDropdown = document.getElementById('user-dropdown');
    const logoutBtn = document.getElementById('logout-btn');
    
    if (userDropdownBtn && userDropdown) {
      userDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle('hidden');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        userDropdown.classList.add('hidden');
      });
    }

    // Logout functionality
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          // Clear auth data
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user_data');
          localStorage.removeItem('user_profile');
          localStorage.removeItem('cart_data');
          
          updateHeaderAuth();
          updateCartCounter();
          
          // Redirect to home page
          window.location.href = '/';
        } catch (error) {
          console.error('Error logging out:', error);
        }
      });
    }
  }

  // Function to update header based on auth state
  function updateHeaderAuth() {
    const guestButtons = document.getElementById('guest-buttons');
    const userMenu = document.getElementById('user-menu');
    const userName = document.getElementById('user-name');
    const adminLink = document.getElementById('admin-link');

    if (authService.isAuthenticated()) {
      // Hide guest buttons, show user menu
      if (guestButtons) guestButtons.style.display = 'none';
      if (userMenu) {
        userMenu.classList.remove('hidden');
        userMenu.style.display = 'flex';
      }
      
      // Set user name with truncation using authService
      if (userName) {
        const displayName = authService.getDisplayName();
        userName.textContent = displayName.toUpperCase();
      }

      // Show/hide admin link based on role using authService
      if (adminLink) {
        if (authService.isAdmin()) {
          adminLink.classList.remove('hidden');
          adminLink.style.display = 'block';
          console.log('Admin link shown'); // Debug log
        } else {
          adminLink.classList.add('hidden');
          adminLink.style.display = 'none';
          console.log('Admin link hidden - not admin'); // Debug log
        }
      }

      // Update admin access across all components
      if ((window as any).updateAdminAccess) {
        (window as any).updateAdminAccess();
      }
    } else {
      // Show guest buttons, hide user menu
      if (guestButtons) guestButtons.style.display = 'flex';
      if (userMenu) {
        userMenu.classList.add('hidden');
        userMenu.style.display = 'none';
      }

      // Hide admin link when not authenticated
      if (adminLink) {
        adminLink.classList.add('hidden');
        adminLink.style.display = 'none';
        console.log('Admin link hidden - not authenticated'); // Debug log
      }

      // Update admin access when not authenticated
      if ((window as any).updateAdminAccess) {
        (window as any).updateAdminAccess();
      }
    }
  }

  // Function to update cart counter
  function updateCartCounter() {
    const cartCounter = document.getElementById('cart-counter');
    
    if (!authService.isAuthenticated() || !cartCounter) {
      if (cartCounter) cartCounter.classList.add('hidden');
      return;
    }

    try {
      // Get cart from localStorage or cart manager
      let totalItems = 0;
      
      if ((window as any).cartManager) {
        totalItems = (window as any).cartManager.getItemCount();
      } else {
        const cartData = localStorage.getItem('cart_data');
        if (cartData) {
          try {
            const cart = JSON.parse(cartData);
            if (cart.items && Array.isArray(cart.items)) {
              totalItems = cart.items.reduce((total: number, item: any) => {
                return total + (item.quantity || 0);
              }, 0);
            }
          } catch (error) {
            console.error('Error parsing cart data:', error);
          }
        }
      }
      
      if (totalItems > 0) {
        cartCounter.textContent = totalItems.toString();
        cartCounter.classList.remove('hidden');
      } else {
        cartCounter.classList.add('hidden');
      }
    } catch (error) {
      console.error('Error updating cart counter:', error);
      if (cartCounter) cartCounter.classList.add('hidden');
    }
  }

  // Make functions available globally
  (window as any).updateHeaderAuth = updateHeaderAuth;
  (window as any).updateCartCounter = updateCartCounter;
  (window as any).isAuthenticated = isAuthenticated;
  (window as any).getCurrentUser = getCurrentUser;

  // Listen for storage changes (cross-tab sync)
  window.addEventListener('storage', (e) => {
    if (e.key === 'auth_token' || e.key === 'user_data' || e.key === 'cart_data') {
      updateHeaderAuth();
      updateCartCounter();
    }
  });
</script>
